<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Little Lamb Fellowship â€” Youth</title>
  <meta name="description" content="A welcoming Christian youth community â€” friends, service, and growth." />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/theme.css?v=2">
  <link rel="icon" href="assets/images/favicon.png">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  <header class="site-header">
    <div class="container">
      <a class="brand" href="index.html">LLF of ACC</a>
      <nav aria-label="Primary">
        <a href="events.html">Events</a>
        <a href="songs.html">Songs</a>
        <a href="contact.html">Prayer</a>
        <a href="photos.html">Photos</a>
      </nav>
      <div class="header-actions">
        <button id="qrBtn" class="btn ghost" aria-haspopup="dialog" aria-controls="qrModal">QR</button>
        <button id="modeToggle" class="btn ghost" aria-pressed="false" aria-label="Toggle dark mode">ðŸŒ™</button>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <section class="card">
      <h1>Prayer Request</h1>
      <form action="https://formspree.io/f/mandojop" method="POST" id="prayForm" novalidate>
        <label for="pray-name">Name (optional)
          <input type="text" id="pray-name" name="name" autocomplete="name" />
        </label>
        <label for="pray-request">How can we pray for you? *
          <textarea id="pray-request" name="request" rows="5" required aria-describedby="pray-request-help"></textarea>
          <div id="pray-request-help" class="field-help muted small">Share what's on your heart - we're here to pray with you.</div>
        </label>
        <label for="pray-email">Email for followâ€‘up (optional)
          <input type="email" id="pray-email" name="email" autocomplete="email" />
        </label>
        
        <!-- Honeypot for spam protection -->
        <div style="position:absolute; left:-9999px" aria-hidden="true">
          <label>Leave empty <input type="text" name="_hp"></label>
        </div>
        
        <button class="btn" type="submit">Send Prayer Request</button>
        <p id="prayStatus" class="muted small" role="status" aria-live="polite"></p>
      </form>
      <p class="muted small">Or email <a href="mailto:leaders@example.com">leaders@example.com</a></p>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>Â© <span id="year"></span> Little Lamb Fellowship Youth Â· You're loved & welcome here.</small>
      <div id="verseBox" class="verse" aria-live="polite"></div>
    </div>
  </footer>

  <!-- QR Modal -->
  <dialog id="qrModal" class="modal">
    <article class="card">
      <header class="modal-header">
        <h3>Share this page</h3>
        <button class="btn ghost" id="qrClose" aria-label="Close">âœ•</button>
      </header>
      <img src="assets/images/qr_image.jpg" alt="QR code to this site" class="responsive" />
      <p class="small muted">Point your camera at the code to open this site.</p>
    </article>
  </dialog>

  <script src="assets/js/script.js" defer></script>
  <script src="assets/js/prayer-encryption.js" defer></script>
  <script>
    // Encrypted prayer form handling
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('prayForm');
      const status = document.getElementById('prayStatus');
      
      // Public encryption key for the church (this would be generated by admins)
      const PUBLIC_ENCRYPTION_KEY = `{"kty":"oct","k":"YOUR_BASE64_KEY_HERE","alg":"A256GCM","use":"enc"}`;
      
      if (!form) return;

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const name = formData.get('name')?.trim() || '';
        const request = formData.get('request')?.trim() || '';
        const email = formData.get('email')?.trim() || '';
        
        // Validate required fields
        if (!request) {
          status.textContent = 'Please enter your prayer request.';
          status.className = 'muted small status-error';
          return;
        }

        // Check honeypot
        if (formData.get('_hp')) {
          status.textContent = 'Thank you for your submission.';
          status.className = 'muted small status-success';
          form.reset();
          return;
        }

        // Show loading state
        status.textContent = 'Encrypting and submitting prayer request...';
        status.className = 'muted small';
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        submitBtn.disabled = true;

        try {
          const encryptionSystem = new EncryptedPrayerSystem();
          
          // For demo purposes, generate a key (in production, use a pre-shared key)
          let encryptionKey;
          try {
            // Try to use the public key, or generate one for demo
            if (PUBLIC_ENCRYPTION_KEY.includes('YOUR_BASE64_KEY_HERE')) {
              // Generate a demo key
              const keyInfo = await encryptionSystem.generateKey();
              encryptionKey = keyInfo.key;
              console.log('Demo encryption key generated. In production, use a pre-shared key.');
              console.log('Admin key for decryption:', keyInfo.keyString);
            } else {
              encryptionKey = await encryptionSystem.importKey(PUBLIC_ENCRYPTION_KEY);
            }
          } catch (keyError) {
            throw new Error('Failed to load encryption key: ' + keyError.message);
          }

          // Create encrypted prayer request
          const encryptedPrayer = await encryptionSystem.createEncryptedPrayerRequest(
            name,
            request,
            email,
            encryptionKey
          );

          // Try multiple submission methods
          let success = false;
          
          // Method 1: Try Formspree with encrypted data
          try {
            const formspreeData = new FormData();
            formspreeData.append('encrypted_prayer', JSON.stringify(encryptedPrayer));
            formspreeData.append('timestamp', encryptedPrayer.timestamp);
            formspreeData.append('has_name', encryptedPrayer.hasName ? 'yes' : 'no');
            formspreeData.append('has_email', encryptedPrayer.hasEmail ? 'yes' : 'no');
            
            const formspreeResponse = await fetch('https://formspree.io/f/mandojop', {
              method: 'POST',
              body: formspreeData,
              headers: {
                'Accept': 'application/json'
              }
            });
            
            if (formspreeResponse.ok) {
              success = true;
              console.log('Encrypted prayer request sent via Formspree');
            }
          } catch (e) {
            console.log('Formspree submission failed:', e.message);
          }

          // Method 2: Store in localStorage as backup (for demo)
          try {
            const stored = JSON.parse(localStorage.getItem('llf_encrypted_prayers') || '[]');
            stored.unshift(encryptedPrayer);
            // Keep only last 50 prayers
            if (stored.length > 50) stored.splice(50);
            localStorage.setItem('llf_encrypted_prayers', JSON.stringify(stored));
            success = true;
            console.log('Encrypted prayer request stored locally');
          } catch (e) {
            console.log('Local storage failed:', e.message);
          }

          if (success) {
            status.textContent = 'ðŸ”’ Thank you! Your prayer request has been encrypted and submitted securely. Our prayer team will be praying for you.';
            status.className = 'muted small status-success';
            form.reset();
            
            // Show encryption confirmation
            setTimeout(() => {
              status.textContent += ' Your request is protected with military-grade encryption.';
            }, 2000);
          } else {
            throw new Error('All submission methods failed');
          }

        } catch (error) {
          console.error('Prayer request submission failed:', error);
          status.textContent = 'Sorry, there was an error submitting your request. Please try again or contact us directly.';
          status.className = 'muted small status-error';
        } finally {
          // Restore button state
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
